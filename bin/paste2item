#!/bin/sh
set -eu

: "${OPENAI_API_KEY:?Set OPENAI_API_KEY first}"
MODEL="${OPENAI_MODEL:-gpt-4o-mini}"
TZ_DEFAULT="${TZ_DEFAULT:-America/New_York}"

# Input: stdin if piped, else pbpaste
if [ -t 0 ]; then
  IN="$(pbpaste)"
else
  IN="$(cat)"
fi

# trim-check for empty/whitespace-only
if [ -z "${IN#"${IN%%[![:space:]]*}"}" ]; then
  echo "paste2item: empty input" >&2
  exit 2
fi

RESP="$(
  curl -sS https://api.openai.com/v1/responses \
    -H "Authorization: Bearer $OPENAI_API_KEY" \
    -H "Content-Type: application/json" \
    -d "$(jq -n --arg model "$MODEL" --arg tz "$TZ_DEFAULT" --arg input "$IN" '
      {
        model: $model,
        instructions:
          "Convert the user input into either iCalendar (.ics) OR vCard (.vcf) CONTENT.\n" +
          "Output ONLY the raw file content. No commentary. No code fences.\n" +
          "If EVENT: output a valid VCALENDAR with exactly one VEVENT.\n" +
          "  - If timezone unspecified, assume " + $tz + ".\n" +
          "  - If start time present but no end time, assume 60 minutes.\n" +
          "  - If date only, make it an all-day event.\n" +
          "If CONTACT: output a valid VCARD 3.0.\n" +
          "If ambiguous, pick the most likely and proceed (do not ask questions).",
        input: $input
      }'
    )"
)"

OUT="$(printf '%s' "$RESP" | jq -r '
  [ .output[]?
    | select(.type=="message")
    | .content[]?
    | select(.type=="output_text")
    | .text
  ] | join("")
')"

case "$OUT" in
  BEGIN:VCALENDAR*)
    ext="ics"
    ;;
  BEGIN:VCARD*)
    ext="vcf"
    ;;
  *)
    echo "paste2item: model output did not look like ICS/VCF" >&2
    echo "$OUT" | head -c 400 >&2
    echo >&2
    exit 1
    ;;
esac

file="$(mktemp -t paste2item.XXXXXX).$ext"
printf '%s\n' "$OUT" > "$file"
open "$file"
echo "$file"
